# ===== Base variables =====
PROJECT_NAME := "shortener_url"
DC := "docker-compose"
DC_FILE := "docker-compose.yaml"
ENV_FILE := "env/.env"


# ===== Help =====
help:
    @echo "Available commands:"
    @echo ""
    @echo "Environment Management:"
    @echo "  set_docker_env               - Configure environment for Docker (postgres:5432)"
    @echo "  set_local_env                - Configure environment for localhost (localhost:5433)"
    @echo ""
    @echo "Docker automation:"
    @echo "  up            - Start required containers (postgres + redis)"
    @echo "  redis-cli     - Connect to Redis CLI"
    @echo "  migrate-up    - Apply database migrations"
    @echo "  migrate-down  - Rollback last migration"
    @echo "  start-app     - Start application container"
    @echo "  full-up       - Complete startup (containers + migrations + app)"
    @echo "  down          - Stop all containers"
    @echo ""
    @echo "Migration workflow:"
    @echo "  1. just up          # Start database and redis"
    @echo "  2. just migrate-up  # Apply migrations"
    @echo "  3. just start-app   # Start application"
    @echo "  OR use 'just full-up' for all steps"
    @echo ""
    @echo "Linters & Formatters:"
    @echo "  lint                         - Run code linters and formatters"
    @echo ""
    @echo "Alembic migrations:"
    @echo "  make_migrate NAME            - Create new migration with autogenerate"
    @echo "  make_migrate_docker NAME     - Create migration for Docker environment"
    @echo "  make_migrate_local NAME      - Create migration for local environment"
    @echo "  make_downgrade NAME          - Downgrade migration to specific revision"
    @echo ""
    @echo "Run 'just COMMAND --help' for more information on a command."


# ===== Environment Management =====
set_docker_env:
    @sed -i '' 's/^DB_HOST=.*/DB_HOST=postgres/' env/.env
    @sed -i '' 's/^DB_PORT=.*/DB_PORT=5432/' env/.env
    @sed -i '' 's/^REDIS_HOST=.*/REDIS_HOST=redis/' env/.env
    @echo "Environment set for DOCKER (postgres:5432, redis:6379)"

set_local_env:
    @sed -i '' 's/^DB_HOST=.*/DB_HOST=localhost/' env/.env
    @sed -i '' 's/^DB_PORT=.*/DB_PORT=5433/' env/.env
    @sed -i '' 's/^REDIS_HOST=.*/REDIS_HOST=localhost/' env/.env
    @echo "Environment set for LOCAL (localhost:5433, localhost:6379)"

freeze-dev:
    @echo "Generating requirements.txt for development..."
    uv pip compile pyproject.toml --extra dev -o requirements.txt
    @echo "requirements.txt generated for development."

freeze-prod:
    @echo "Generating requirements.txt for production..."
    uv pip compile pyproject.toml -o requirements.txt
    @echo "requirements.txt generated for production."

rm-requirements:
    @echo "Remove requirements.txt..."
    rm requirements.txt

# ===== Docker automation =====
up:
    @echo "Starting containers (postgres + redis)..."
    {{DC}} --env-file {{ENV_FILE}} -p {{PROJECT_NAME}} -f {{DC_FILE}} up -d --build postgres redis
    @echo "Containers started. Run migrations manually with 'just migrate-up'"

down:
    @echo "Stop the url api Docker container ..."
    {{DC}} --env-file {{ENV_FILE}} -p {{PROJECT_NAME}} -f {{DC_FILE}} down -v
    @echo "Success down!"

redis-cli:
    @echo "Connecting to Redis CLI..."
    {{DC}} --env-file {{ENV_FILE}} -p {{PROJECT_NAME}} -f {{DC_FILE}} exec redis redis-cli

migrate-up:
    @echo "Running migrations..."
    {{DC}} --env-file {{ENV_FILE}} -p {{PROJECT_NAME}} -f {{DC_FILE}} run --rm fastapi python -m alembic upgrade head
    @echo "Migrations completed"

migrate-down:
    @echo "Downgrading migrations..."
    {{DC}} --env-file {{ENV_FILE}} -p {{PROJECT_NAME}} -f {{DC_FILE}} run --rm fastapi python -m alembic downgrade -1
    @echo "Migrations downgraded"

start-app:
    @echo "Starting application..."
    {{DC}} --env-file {{ENV_FILE}} -p {{PROJECT_NAME}} -f {{DC_FILE}} up -d fastapi
    @echo "Application started"

full-up: freeze-dev up migrate-up start-app rm-requirements
    @echo "Full startup completed (containers + migrations + app)"



# ===== Setup automation =====


# ===== Linters & Formatter automation =====
lint:
    @echo "Start linters ..."
    - ruff check --fix --silent .
    - ruff format --silent .
    @echo "Linters done!"


# ===== Alembic migrations =====
make_migrate ARG:
    @echo "Make alembic revision with name: {{ARG}}"
    @alembic revision --autogenerate -m {{ARG}}

make_migrate_local ARG:
    @just set_local_env
    @just make_migrate {{ARG}}

make_downgrade_local ARG:
    @just set_local_env
    @just make_downgrade {{ARG}}