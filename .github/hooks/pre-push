#!/usr/bin/env bash
set -euo pipefail

# Colors (disable colors if not a TTY)
if [[ -t 1 ]]; then
  RED='\033[0;31m'
  GREEN='\033[0;32m'
  YELLOW='\033[1;33m'
  BLUE='\033[0;34m'
  NC='\033[0m'
else
  RED=""
  GREEN=""
  YELLOW=""
  BLUE=""
  NC=""
fi

ROOT="$(git rev-parse --show-toplevel)"
BACKEND_DIR="${ROOT}/backend"

# ---- Required tools ----
if ! command -v just >/dev/null 2>&1; then
  echo -e "${RED}[‚ùå] just not found in PATH.${NC}"
  exit 1
fi

if [[ ! -d "${BACKEND_DIR}" ]]; then
  echo -e "${RED}[‚ùå] backend/ directory not found. Hook expects monorepo layout.${NC}"
  exit 1
fi

need_import_linter=0
need_ty=0
checked_any=0

# pre-push stdin format:
# local_ref local_sha remote_ref remote_sha
while read -r local_ref local_sha remote_ref remote_sha; do
  # ignore non-branch refs (tags etc)
  [[ "${local_ref}" == refs/heads/* ]] || continue

  # ignore branch deletion (sha == 0000..)
  if [[ "${local_sha}" =~ ^0+$ ]]; then
    continue
  fi

  checked_any=1

  # If new branch (remote_sha is all zeros) -> run checks
  if [[ "${remote_sha}" =~ ^0+$ ]]; then
    need_import_linter=1
    need_ty=1
    continue
  fi

  # Any changes in backend/ => import-linter
  if git diff --name-only "${remote_sha}".."${local_sha}" -- backend | grep -q .; then
    need_import_linter=1
  fi

  # Only python changes in backend/src or backend/tests => ty
  if git diff --name-only "${remote_sha}".."${local_sha}" -- backend/src backend/tests | grep -E '\.pyi?$' -q; then
    need_ty=1
  fi
done

# Nothing to check (e.g. pushing only tags)
if [[ "${checked_any}" -eq 0 ]]; then
  exit 0
fi

cd "${BACKEND_DIR}"

# import-linter
if [[ "${need_import_linter}" -eq 1 ]]; then
  echo -e "${BLUE}[üöÄ] Running import-linter via just...${NC}"
  just import-linter
  echo -e "${GREEN}[‚úÖ] import-linter passed.${NC}"
else
  echo -e "${BLUE}[‚ÑπÔ∏è] No changes in backend/. Skipping import-linter.${NC}"
fi

# ty
if [[ "${need_ty}" -eq 1 ]]; then
  echo -e "${BLUE}[üöÄ] Running ty type-check via just...${NC}"
  just ty
  echo -e "${GREEN}[‚úÖ] ty passed.${NC}"
else
  echo -e "${BLUE}[‚ÑπÔ∏è] No Python changes in backend/src or backend/tests. Skipping ty.${NC}"
fi

echo -e "${GREEN}[‚úÖ] Pre-push OK. Proceeding with push.${NC}"
exit 0
